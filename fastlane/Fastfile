default_platform(:ios)

platform :ios do
  lane :build_and_upload do
    # Increment build number
  desc "Increment build number"
    build_number = increment_build_number(
      xcodeproj: "SDDSDemoApp/SDDSDemoApp.xcodeproj")
    
    # Update Info.plist
  desc "Update Info.plist"
    version = get_version_number(xcodeproj: "SDDSDemoApp/SDDSDemoApp.xcodeproj", target: "SDDSDemoApp")
    
    ENV["VERSION"] = version

    # Build app
  desc "Build app"
    branch_name = git_branch
    version = ENV["VERSION"]
    build_name = "SDDSDemo #{version} #{build_number} #{branch_name}"
    
    build_app(
      scheme: "SDDSDemoApp",
      xcargs: "-allowProvisioningUpdates")
    
    # Upload to TestFlight
  desc "Upload to TestFlight"
    upload_to_testflight(
      api_key: {
        key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key_filepath: ENV["APP_STORE_CONNECT_API_KEY"]
      })
  end
end

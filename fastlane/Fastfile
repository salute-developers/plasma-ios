default_platform(:ios)

platform :ios do
    # Increment build number
  desc: "Increment build number"
  lane :increment_build_number do
     increment_build_number(
      xcodeproj: "SDDSDemoApp.xcodeproj"
    )
  end
    
    # Update Info.plist
  desc: "Update Info.plist"
  lane :update_info_plist do
    version = get_version_number(xcodeproj: "SDDSDemoApp.xcodeproj", target: "SDDSDemoApp")
    
    ENV["VERSION"] = version
    
    update_info_plist(
      plist_path: "build/Info.plist",
      plist_key: "CFBundleDisplayName",
      plist_value: new_app_name
    )
  end

    # Build app
  desc: "Build app"
  lane :build_app do
    branch_name = git_branch
    version = ENV["VERSION"]
    build_name = "SDDSDemo #{version} #{build_number} #{brunch_name}"
    
    build_app(
      scheme: "SDDSDemo",
      workspace: "SDDS.xcworkspace"
      export_method: "app-store",
      include_bitcode: true,
      include_symbols: true
    )
  end
    
    # Upload to TestFlight
  desc: "Upload to TestFlight"
  lane :upload_to_testflight
    upload_to_testflight(
      api_key: {
        key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key_filepath: ENV["APP_STORE_CONNECT_API_KEY"]
      }
  end
  
  desc: "Build and upload to TestFlight"
  lane :build_and_upload do
    increment_build_number
    build_app
    update_info_plist
    upload_to_testflight
  end
end

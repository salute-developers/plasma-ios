default_platform(:ios)

platform :ios do
  lane :build_and_upload do
    # Increment build number
    build_number = increment_build_number(
      xcodeproj: "SDDSDemoApp/SDDSDemoApp.xcodeproj")
    
    # Update Info.plist
    version = get_version_number(xcodeproj: "SDDSDemoApp/SDDSDemoApp.xcodeproj", target: "SDDSDemoApp")
    
    ENV["VERSION"] = version
    version = ENV["VERSION"]
        
    # Check current branch
    branch_name = git_branch

    if branch_name == "develop"
      build_name = "SDDSDemo #{version} #{build_number} (dev)"
    else
      build_name = "SDDSDemo"
    end

    # Build app
    build_app(
      scheme: "SDDSDemoApp",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.sd.SDDSDemo" => "SDDS Demo Distribution",
        }
      },
      output_name: build_name
    )
    
    # Upload to TestFlight
  desc "Upload to TestFlight"
    upload_to_testflight(
      api_key: {
        key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key_filepath: ENV["APP_STORE_CONNECT_API_KEY"]
      })
  end
end

name: "Generate Changelog for Documentation"

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚ÑÐ³Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ release-16-04-2025)'
        required: true
      artifact_id:
        description: 'ID Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ changelog'
        required: true
        default: 'SDDSComponents'
      version:
        description: 'Ð’ÐµÑ€ÑÐ¸Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°'
        required: true
        default: '1.0.0'
      target_type:
        description: 'Ð¢Ð¸Ð¿ Ñ†ÐµÐ»Ð¸ (swiftui)'
        required: true
        default: 'swiftui'
      theme_name:
        description: 'ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ‚ÐµÐ¼Ñ‹'
        required: true
        default: 'SDDS iOS Components'
      code_reference:
        description: 'Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° ÐºÐ¾Ð´'
        required: true
        default: 'SDDSComponents'

jobs:
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    environment: sdds
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        id: changelog
        uses: ./.github/actions/release-changelog
        with:
          fromTag: ${{ github.event.inputs.tag_name }}

      - name: Create release-changelog.md
        run: |
          cat > release-changelog.md <<EOF
          ${{ steps.changelog.outputs.changelog }}
          EOF

      - name: Generate Documentation with Changelog
        run: |
          cd docusaurus
          ./deploy.sh --local --with-changelog \
            "${{ github.event.inputs.artifact_id }}" \
            "${{ github.event.inputs.version }}" \
            "main" \
            "${{ github.event.inputs.target_type }}" \
            "${{ github.event.inputs.theme_name }}" \
            "${{ github.event.inputs.code_reference }}"

      - name: Upload Generated Documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation-with-changelog
          path: docusaurus/build/generated/docusaurus/
          retention-days: 30

      - name: Show Changelog Content
        run: |
          echo "ðŸ“ Generated Changelog:"
          echo "========================"
          if [[ -f "release-changelog.md" ]]; then
            cat release-changelog.md
          else
            echo "No changelog file found"
          fi
          echo ""
          echo "ðŸ“ Generated Documentation Structure:"
          echo "===================================="
          if [[ -d "docusaurus/build/generated/docusaurus" ]]; then
            find docusaurus/build/generated/docusaurus -name "*.md" | head -20
            echo "..."
          else
            echo "No documentation generated"
          fi

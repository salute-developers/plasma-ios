name: 'Deploy tokens docs common'

on:
  workflow_call:
    inputs:
      modules:
        type: string
        description: 'Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ json (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ["styles-salute-theme", "sddsserv-theme", "plasma-b2c-theme", "plasma-home-ds-theme"]). Ð•ÑÐ»Ð¸ Ð¿ÑƒÑÑ‚Ð¾Ðµ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð²ÐµÑÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ‚ÐµÐ¼.'
        required: false
        default: '["styles-salute-theme", "sddsserv-theme", "plasma-b2c-theme", "plasma-home-ds-theme"]'
      ref:
        type: string
        description: 'ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð²ÐµÑ‚ÐºÐ¸, Ñ‚ÑÐ³Ð° Ð¸Ð»Ð¸ Ñ…ÑÑˆ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°'
        required: true
      branch:
        type: string
        description: 'ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð²ÐµÑ‚ÐºÐ¸ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ'
        required: false
      custom_deploy_path:
        type: string
        description: 'ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: test/custom/path/ Ð¸Ð»Ð¸ experimental/ios/components/)'
        required: false

jobs:
  changelog:
    name: Prepare changelog
    runs-on: ubuntu-latest
    outputs:
      content: ${{ steps.build-changelog.outputs.changelog }}
      changelog_json: ${{ steps.build-changelog.outputs.changelog_json }}
    steps:
      # Ð’ÑÐµÐ³Ð´Ð° Ð´ÐµÐ»Ð°ÐµÐ¼ checkout main Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ… workflow Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸ actions
      - name: Checkout main (for workflows and actions)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive

      - name: Build Changelog
        id: build-changelog
        uses: ./.github/actions/release-changelog
        with:
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÐ³ Ñ€ÐµÐ»Ð¸Ð·Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ changelog
          toTag: ${{ inputs.ref }}
      
      - name: Debug raw changelog from mikepenz action
        shell: bash
        run: |
          echo "ðŸ” Debug: Raw changelog from mikepenz action (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 1000 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²):"
          echo "${{ steps.build-changelog.outputs.changelog }}" | head -c 1000 || echo "Changelog Ð¿ÑƒÑÑ‚ Ð¸Ð»Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          echo ""
          echo "ðŸ” Ð”Ð»Ð¸Ð½Ð° changelog: $(echo "${{ steps.build-changelog.outputs.changelog }}" | wc -c) ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
  deploy:
    name: Deploy docs
    needs: changelog
    runs-on: macos-latest
    environment: sdds
    if: inputs.ref != ''
    strategy:
      fail-fast: false
      matrix:
        module: 
          - sddsserv-theme
          - styles-salute-theme
          - plasma-b2c-theme
          - plasma-home-ds-theme
        include:
          - module: sddsserv-theme
            theme_name: sddsserv
          - module: styles-salute-theme
            theme_name: styles-salute
          - module: plasma-b2c-theme
            theme_name: plasma-b2c
          - module: plasma-home-ds-theme
            theme_name: plasma-homeds
    steps:
      - name: Check if module should be deployed
        id: check_module
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ Ð² ÑÐ¿Ð¸ÑÐºÐµ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
          modules='${{ inputs.modules }}'
          module='${{ matrix.module }}'
          
          # Ð•ÑÐ»Ð¸ modules Ð¿ÑƒÑÑ‚Ð¾Ðµ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
          if [[ -z "$modules" || "$modules" == "" ]]; then
            modules='["styles-salute-theme", "sddsserv-theme", "plasma-b2c-theme", "plasma-home-ds-theme"]'
            echo "ðŸ” Using default modules list: $modules"
          fi
          
          echo "ðŸ” Debug info:"
          echo "  modules='$modules'"
          echo "  module='$module'"
          echo "  modules length: ${#modules}"
          echo "  module length: ${#module}"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°
          if echo "$modules" | grep -q "\"$module\"" || echo "$modules" | grep -q "'$module'" || echo "$modules" | grep -q "$module"; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Module '$module' found in modules list"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ Module '$module' not found in modules list"
          fi
      
      # Ð’ÑÐµÐ³Ð´Ð° Ð´ÐµÐ»Ð°ÐµÐ¼ checkout main Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ… workflow Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸ actions
      - name: Checkout main (for workflows and actions)
        if: steps.check_module.outputs.should_deploy == 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive

      - name: Create release-changelog.md
        if: steps.check_module.outputs.should_deploy == 'true'
        shell: bash
        run: |
          cat > "${{ github.workspace }}/release-changelog.md" <<EOF
          ${{ needs.changelog.outputs.content }}
          EOF
          echo "ðŸ” Debug: release-changelog.md ÑÐ¾Ð·Ð´Ð°Ð½, Ñ€Ð°Ð·Ð¼ÐµÑ€: $(wc -c < "${{ github.workspace }}/release-changelog.md") Ð±Ð°Ð¹Ñ‚"
          echo "ðŸ” ÐŸÐµÑ€Ð²Ñ‹Ðµ 100 ÑÑ‚Ñ€Ð¾Ðº release-changelog.md:"
          head -100 "${{ github.workspace }}/release-changelog.md" || echo "Ð¤Ð°Ð¹Ð» Ð¿ÑƒÑÑ‚ Ð¸Ð»Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
      
      - name: Create release-changelog.json
        if: steps.check_module.outputs.should_deploy == 'true'
        shell: bash
        run: |
          cat > "${{ github.workspace }}/release-changelog.json" <<EOF
          ${{ needs.changelog.outputs.changelog_json }}
          EOF
          echo "ðŸ” Debug: release-changelog.json ÑÐ¾Ð·Ð´Ð°Ð½, Ñ€Ð°Ð·Ð¼ÐµÑ€: $(wc -c < "${{ github.workspace }}/release-changelog.json") Ð±Ð°Ð¹Ñ‚"
          echo "ðŸ” Changelog JSON:"
          cat "${{ github.workspace }}/release-changelog.json" | jq . || echo "JSON Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´ÐµÐ½"

      - name: Set up Xcode
        if: steps.check_module.outputs.should_deploy == 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'
          
      - name: Install the Apple certificate and provisioning profile
        if: steps.check_module.outputs.should_deploy == 'true'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          chmod +x ./scripts/install_certificate_and_profile.sh
          ./scripts/install_certificate_and_profile.sh "$RUNNER_TEMP" "$BUILD_CERTIFICATE_BASE64" "$P12_PASSWORD" "$BUILD_PROVISION_PROFILE_BASE64" "$KEYCHAIN_PASSWORD"

      - name: Extract branch name
        if: steps.check_module.outputs.should_deploy == 'true'
        id: extract_branch
        shell: bash
        run: |
          if [[ -n "${{ inputs.branch }}" ]]; then
            echo "branch=${{ inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check_module.outputs.should_deploy == 'true'
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Node.js Ð¸ Yarn Ñ‡ÐµÑ€ÐµÐ· Homebrew
          brew install node yarn jq s3cmd

      - name: Build SDDSComponentsFixtures
        if: steps.check_module.outputs.should_deploy == 'true'
        run: |
          echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° SDDSComponentsFixtures Ð´Ð»Ñ iOS Simulator..."
          cd SDDSComponentsFixtures
          xcodebuild -scheme SDDSComponentsFixtures -destination 'generic/platform=iOS Simulator' build
          echo "âœ… SDDSComponentsFixtures ÑÐ¾Ð±Ñ€Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"

      - name: Run deploy and collect result
        if: steps.check_module.outputs.should_deploy == 'true'
        id: deploy
        env:
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_REGION: ${{ secrets.S3_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          ARTIFACT_ID: ":tokens:${{ matrix.module }}"
          VERSION_INPUT: ${{ inputs.ref }}
          BRANCH_NAME: ${{ steps.extract_branch.outputs.branch }}
          TARGET_TYPE: swiftui
          THEME_NAME: ${{ matrix.theme_name }}
          DOCS_URL: https://plasma.sberdevices.ru
        run: |
          cd docusaurus
          
          # ÐžÑ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          echo "ðŸ” ÐžÑ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:"
          echo "  S3_ACCESS_KEY_ID: '${S3_ACCESS_KEY_ID:0:3}***' (Ð´Ð»Ð¸Ð½Ð°: ${#S3_ACCESS_KEY_ID})"
          echo "  S3_SECRET_ACCESS_KEY: '${S3_SECRET_ACCESS_KEY:0:3}***' (Ð´Ð»Ð¸Ð½Ð°: ${#S3_SECRET_ACCESS_KEY})"
          echo "  S3_ENDPOINT: '$S3_ENDPOINT' (Ð´Ð»Ð¸Ð½Ð°: ${#S3_ENDPOINT})"
          echo "  S3_REGION: '$S3_REGION' (Ð´Ð»Ð¸Ð½Ð°: ${#S3_REGION})"
          echo "  S3_BUCKET: '$S3_BUCKET' (Ð´Ð»Ð¸Ð½Ð°: ${#S3_BUCKET})"
          
          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð´ÐµÐ¿Ð»Ð¾Ñ Ñ S3 Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸ ÐºÐ°Ðº Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸
          # ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ VERSION_INPUT (Ñ‚ÐµÐ³) Ð² deploy.sh, Ð¾Ð½ ÑÐ°Ð¼ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÑ‚ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· Xcode Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          DEPLOY_CMD="./deploy.sh --s3 \"$ARTIFACT_ID\" \"$VERSION_INPUT\" \"$BRANCH_NAME\" \"$TARGET_TYPE\" \"$THEME_NAME\" \"$CODE_REFERENCE\" \"$DOCS_URL\" \"$S3_ACCESS_KEY_ID\" \"$S3_SECRET_ACCESS_KEY\" \"$S3_ENDPOINT\" \"$S3_REGION\" \"$S3_BUCKET\""
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð´ÐµÐ¿Ð»Ð¾Ñ ÐµÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½
          if [[ -n "${{ inputs.custom_deploy_path }}" ]]; then
            DEPLOY_CMD="./deploy.sh --s3 \"$ARTIFACT_ID\" \"$VERSION_INPUT\" \"$BRANCH_NAME\" \"$TARGET_TYPE\" \"$THEME_NAME\" \"$CODE_REFERENCE\" \"$DOCS_URL\" \"$S3_ACCESS_KEY_ID\" \"$S3_SECRET_ACCESS_KEY\" \"$S3_ENDPOINT\" \"$S3_REGION\" \"$S3_BUCKET\" --deploy-path=\"${{ inputs.custom_deploy_path }}\""
          fi
          
          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹
          echo "ðŸš€ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: $DEPLOY_CMD"
          echo "ðŸ” S3 Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ñ‹ ÐºÐ°Ðº Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹"
          eval $DEPLOY_CMD

      - name: Run deploy changelog
        if: steps.check_module.outputs.should_deploy == 'true'
        env:
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_REGION: ${{ secrets.S3_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          cd docusaurus
          ./scripts/deploy-changelog.sh \
            ":tokens:${{ matrix.module }}" \
            "${{ inputs.ref }}" \
            "${{ steps.extract_branch.outputs.branch }}" \
            "${{ secrets.S3_ACCESS_KEY_ID }}" \
            "${{ secrets.S3_SECRET_ACCESS_KEY }}" \
            "${{ secrets.S3_ENDPOINT }}" \
            "${{ secrets.S3_REGION }}" \
            "${{ secrets.S3_BUCKET }}"

      - name: Prepare deploy artifacts
        if: steps.check_module.outputs.should_deploy == 'true' && success()
        shell: bash
        run: |
          module="${{ matrix.module }}"
          clean_module="${module//-/_}"
          artifact_name="docusaurus-ios-${clean_module}-result"
          mkdir -p artifacts/ios/${module}
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ deploy.json ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
          if [[ -f "docusaurus/build/generated/docusaurus/deploy.json" ]]; then
            cp docusaurus/build/generated/docusaurus/deploy.json artifacts/ios/${module}/deploy.json
            echo "âœ… Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½ deploy.json"
          fi
          
          echo "ARTIFACT_NAME=$artifact_name" >> $GITHUB_ENV
          echo "ðŸ“¦ ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð»ÐµÐ½ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚: $artifact_name"

      - name: Upload deploy result
        if: steps.check_module.outputs.should_deploy == 'true' && success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: artifacts/ios/${{ matrix.module }}/
          
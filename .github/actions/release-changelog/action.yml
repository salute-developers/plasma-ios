name: 'Get release changelog'

description: 'Returns release changelog'

inputs:
  fromTag:
    description: 'Ð¢ÑÐ³, Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð²ÐµÑ‚ÐºÐ¸ Ð¸Ð»Ð¸ Ñ…ÑÑˆ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°'
    required: false
  toTag:
    description: 'Ð¢ÑÐ³, Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð²ÐµÑ‚ÐºÐ¸ Ð¸Ð»Ð¸ Ñ…ÑÑˆ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°'
    required: false


outputs:
  changelog:
    description: "Processed changelog"
    value: ${{ steps.changelog.outputs.changelog }}
  changelog_json:
    description: "Processed changelog json"
    value: ${{ steps.changelog.outputs.changelog_json }}
  pull_requests:
    description: "Pull requests"
    value: ${{ steps.github_release.outputs.pull_requests }}

runs:
  using: "composite"
  steps:
    - name: Compute envs
      shell: bash
      run: |
        # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ TO_TAG
        if [ -z "${{ inputs.toTag }}" ]; then
          # Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐ³Ð¸ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° (Ðº ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼Ñƒ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½ Ñ‚ÐµÐ³), Ð° Ð½Ðµ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ‚ÐµÐ³Ð°
          TO_TAG=$(git tag --sort=-committerdate | grep '^release-' | sed -n '1p')
        else
          TO_TAG="${{ inputs.toTag }}"
        fi

        # Ð—Ð°Ñ‚ÐµÐ¼ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ FROM_TAG
        if [ -z "${{ inputs.fromTag }}" ]; then
          # Ð•ÑÐ»Ð¸ toTag Ð·Ð°Ð´Ð°Ð½, Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÐ³ Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð½ÐµÐ³Ð¾
          if [ -n "$TO_TAG" ]; then
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ñ‚Ñƒ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° Ð´Ð»Ñ TO_TAG
            TO_TAG_DATE=$(git log -1 --format=%ct "$TO_TAG" 2>/dev/null || echo "0")
            echo "ðŸ” DEBUG: TO_TAG=$TO_TAG, TO_TAG_DATE=$TO_TAG_DATE"
            
            # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð²ÑÐµ Ñ‚ÐµÐ³Ð¸ release-* Ñ Ð´Ð°Ñ‚Ð¾Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° Ð ÐÐÐ¬Ð¨Ð•, Ñ‡ÐµÐ¼ TO_TAG
            # Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° (Ð¾Ñ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ðº ÑÑ‚Ð°Ñ€Ñ‹Ð¼) Ð¸ Ð±ÐµÑ€ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ (ÑÐ°Ð¼Ñ‹Ð¹ Ð±Ð»Ð¸Ð·ÐºÐ¸Ð¹ Ðº TO_TAG)
            FROM_TAG=$(git tag -l "release-*" | while read tag; do
              TAG_DATE=$(git log -1 --format=%ct "$tag" 2>/dev/null || echo "0")
              if [ "$TAG_DATE" -lt "$TO_TAG_DATE" ] && [ "$TAG_DATE" -gt 0 ] && [ "$tag" != "$TO_TAG" ]; then
                echo "$TAG_DATE $tag"
              fi
            done | sort -rn | head -1 | awk '{print $2}')
            
            echo "ðŸ” DEBUG: ÐÐ°Ð¹Ð´ÐµÐ½ FROM_TAG=$FROM_TAG"
            
            # Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÐ³ (TO_TAG Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð² ÑÐ¿Ð¸ÑÐºÐµ), Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚
            if [ -z "$FROM_TAG" ] || [ "$FROM_TAG" = "$TO_TAG" ]; then
              FROM_TAG=$(git rev-list --max-parents=0 HEAD | head -1)
              echo "âš ï¸  ÐŸÑ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ‚ÐµÐ³ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚: $FROM_TAG"
            fi
          else
            # Ð•ÑÐ»Ð¸ toTag Ð½Ðµ Ð·Ð°Ð´Ð°Ð½, Ð±ÐµÑ€ÐµÐ¼ Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹ Ñ‚ÐµÐ³ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ°
            FROM_TAG=$(git tag --sort=-committerdate | grep '^release-' | sed -n '2p')
          fi
        else
          FROM_TAG="${{ inputs.fromTag }}"
        fi

        echo "FROM_TAG=$FROM_TAG" >> $GITHUB_ENV
        echo "TO_TAG=$TO_TAG" >> $GITHUB_ENV
        echo "FROM_TAG = $FROM_TAG and TO_TAG = $TO_TAG"
        DATE=$(date +'%d.%m.%Y')
        echo "DATE=$DATE" >> $GITHUB_ENV
        echo "FILE=${{ github.workspace }}/changelog_artifacts.md" >> $GITHUB_ENV

    - name: Build Changelog
      id: github_release
      uses: mikepenz/release-changelog-builder-action@v4.1.0
      with:
        fromTag: ${{ env.FROM_TAG }}
        toTag:  ${{ env.TO_TAG }}
        configuration: "./.github/changelog-builder-config.json"

    - name: Install dependencies
      shell: bash
      run: |
        cd .github/actions/preprocessing-release-changelog
        npm ci

    - name: Processing changelog data
      id: changelog
      uses: ./.github/actions/preprocessing-release-changelog
      with:
        data: |
          ${{ steps.github_release.outputs.changelog }}

    - name: Create "changelog_artifacts.md"
      shell: bash
      run: |
        cat > "${{ env.FILE }}" <<EOF
        ${{ steps.changelog.outputs.changelog }}
        EOF   

    - name: Debug print changelog_artifacts.md
      shell: bash
      run: |
        echo "ðŸ” Contents of changelog_artifacts.md:"
        cat "${{ env.FILE }}"
    
    - name: Debug print changelog JSON
      shell: bash
      run: |
        echo "ðŸ“‹ Changelog JSON:"
        echo "${{ steps.changelog.outputs.changelog_json }}" | jq . || echo "JSON Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´ÐµÐ½"

    - name: Upload "changelog_artifacts.md"
      if: false
      uses: actions/upload-artifact@master
      with:
        name: release-changelog-artifacts
        path: ${{ env.FILE }}